{% extends "base.html" %}
{% load static %}

{% block meta %}<title>Laps – SpeedView</title>{% endblock meta %}

{% block content %}
<div class="px-6 lg:px-12 py-10 space-y-6">
  <div class="text-sm text-white/60 tracking-wide space-x-2">
    <a class="hover:text-red-400" href="{% url 'main:show_main' %}">Home</a>
    <span>›</span>
    <a class="hover:text-red-400" href="{% url 'driver:driver_list' %}">Drivers</a>
    <span>›</span>
    <span class="text-white">Laps</span>
  </div>

  <h1 class="text-3xl font-bold text-white" style="font-family: Alphacorsa, Inter, sans-serif;">Laps</h1>

  <div class="rounded-2xl border border-white/10 bg-gradient-to-br from-[#050816] via-[#020617] to-black p-5 shadow-xl shadow-red-900/20">
    <p class="text-xs uppercase tracking-[0.2em] text-red-400 mb-3">Filters</p>
    <form id="f" class="grid gap-3 sm:grid-cols-2 lg:grid-cols-6">
      <input name="session_key" placeholder="session_key"
             class="px-3 py-2 rounded-xl bg-[#020617] border border-white/15 text-white text-sm focus:outline-none focus:ring-2 focus:ring-red-500/60 focus:border-red-500/60">
      <input name="driver_number" placeholder="driver_number"
             class="px-3 py-2 rounded-xl bg-[#020617] border border-white/15 text-white text-sm focus:outline-none focus:ring-2 focus:ring-red-500/60 focus:border-red-500/60">
      <input name="lap_number" placeholder="lap_number"
             class="px-3 py-2 rounded-xl bg-[#020617] border border-white/15 text-white text-sm focus:outline-none focus:ring-2 focus:ring-red-500/60 focus:border-red-500/60">
      <input name="meeting_key" placeholder="meeting_key"
             class="px-3 py-2 rounded-xl bg-[#020617] border border-white/15 text-white text-sm focus:outline-none focus:ring-2 focus:ring-red-500/60 focus:border-red-500/60">

      <button type="submit"
              class="px-4 py-2 rounded-xl bg-red-600 text-white text-sm font-semibold shadow-md shadow-red-900/40 hover:bg-red-500 transition-colors">
        Load
      </button>
      <button type="button" id="clear"
              class="px-4 py-2 rounded-xl bg-white/5 text-white text-sm hover:bg-white/10 border border-white/10 transition-colors">
        Clear
      </button>
    </form>
  </div>

  <p id="meta" class="text-xs text-white/60">0 item(s)</p>

  <div class="overflow-x-auto rounded-2xl border border-white/10 bg-[#020617] shadow-xl shadow-black/40">
    <table class="min-w-full text-sm text-white/80">
      <thead class="bg-white/5">
        <tr class="text-xs uppercase tracking-wide text-white/70">
          <th class="px-3 py-2 text-left">Date</th>
          <th class="px-3 py-2 text-left">Driver</th>
          <th class="px-3 py-2 text-left">Lap</th>
          <th class="px-3 py-2 text-left">S1</th>
          <th class="px-3 py-2 text-left">S2</th>
          <th class="px-3 py-2 text-left">S3</th>
          <th class="px-3 py-2 text-left">Lap Time</th>
          <th class="px-3 py-2 text-left">i1</th>
          <th class="px-3 py-2 text-left">i2</th>
          <th class="px-3 py-2 text-left">ST</th>
          <th class="px-3 py-2 text-left">Pit out?</th>
        </tr>
      </thead>
      <tbody id="tb"></tbody>
    </table>
  </div>

  <p id="hint" class="text-xs text-white/40">
    Scroll ke bawah untuk memuat 20 data berikutnya.
  </p>
</div>

<script>
const API = "{% url 'laps:api_laps_list' %}";
const PAGE_SIZE = 20;

const f = document.getElementById('f');
const tb = document.getElementById('tb');
const meta = document.getElementById('meta');
const hint = document.getElementById('hint');

let currentFilters = {};
let offset = 0;
let totalCount = 0;
let loadedCount = 0;
let isLoading = false;
let hasMore = true;

function fmt(v, d = '—') {
  return (v || v === 0) ? v : d;
}
function sec(s) {
  if (s || s === 0) return Number(s).toFixed(3);
  return '—';
}

function renderMeta() {
  if (totalCount > 0) {
    meta.textContent = `${loadedCount} dari ${totalCount} item(s)`;
  } else {
    meta.textContent = `${loadedCount} item(s)`;
  }
  if (!hasMore && totalCount > 0) {
    hint.textContent = 'Semua data sudah dimuat.';
  } else {
    hint.textContent = 'Scroll ke bawah untuk memuat 20 data berikutnya.';
  }
}

function appendRows(rows) {
  const html = rows.map(r => `
    <tr class="border-t border-white/10 hover:bg-white/5 transition-colors">
      <td class="px-3 py-2">${fmt(r.date_start_str)}</td>
      <td class="px-3 py-2 font-semibold">#${fmt(r.driver_number)}</td>
      <td class="px-3 py-2">${fmt(r.lap_number)}</td>
      <td class="px-3 py-2">${sec(r.duration_sector_1)}</td>
      <td class="px-3 py-2">${sec(r.duration_sector_2)}</td>
      <td class="px-3 py-2">${sec(r.duration_sector_3)}</td>
      <td class="px-3 py-2 text-red-400 font-medium">${sec(r.lap_duration)}</td>
      <td class="px-3 py-2">${fmt(r.i1_speed)}</td>
      <td class="px-3 py-2">${fmt(r.i2_speed)}</td>
      <td class="px-3 py-2">${fmt(r.st_speed)}</td>
      <td class="px-3 py-2">${r.is_pit_out_lap ? 'Yes' : 'No'}</td>
    </tr>
  `).join('');
  tb.insertAdjacentHTML('beforeend', html);
}

function showLoadingRow() {
  const existing = document.getElementById('loading-row');
  if (existing) return;
  const tr = document.createElement('tr');
  tr.id = 'loading-row';
  tr.innerHTML = `<td class="px-3 py-3 text-white/60 text-center" colspan="11">Loading…</td>`;
  tb.appendChild(tr);
}

function removeLoadingRow() {
  const tr = document.getElementById('loading-row');
  if (tr) tr.remove();
}

async function fetchPage() {
  if (isLoading || !hasMore) return;
  isLoading = true;
  showLoadingRow();

  const params = { ...currentFilters, limit: PAGE_SIZE.toString(), offset: offset.toString() };
  const qs = new URLSearchParams(params);
  try {
    const res = await fetch(`${API}?${qs.toString()}`);
    const json = await res.json();

    if (!json.ok) {
      tb.innerHTML = `<tr><td class="px-3 py-3 text-red-400" colspan="11">${json.error || 'Failed'}</td></tr>`;
      meta.textContent = '—';
      hint.textContent = '';
      isLoading = false;
      return;
    }

    removeLoadingRow();

    const rows = json.data || [];
    totalCount = json.count || 0;
    loadedCount += rows.length;
    offset = json.next_offset != null ? json.next_offset : loadedCount;
    hasMore = json.has_more === true;

    if (loadedCount === 0) {
      tb.innerHTML = `<tr><td class="px-3 py-3 text-white/60 text-center" colspan="11">No data.</td></tr>`;
    } else {
      appendRows(rows);
    }
    renderMeta();
  } catch (e) {
    tb.innerHTML = `<tr><td class="px-3 py-3 text-red-400" colspan="11">Error: ${e}</td></tr>`;
    meta.textContent = '—';
    hint.textContent = '';
  } finally {
    removeLoadingRow();
    isLoading = false;
  }
}

function resetState() {
  tb.innerHTML = '';
  offset = 0;
  totalCount = 0;
  loadedCount = 0;
  hasMore = true;
  renderMeta();
}

f.addEventListener('submit', (e) => {
  e.preventDefault();
  const formData = new FormData(f);
  const filters = {};
  for (const [k, v] of formData.entries()) {
    if (v) filters[k] = v.toString();
  }
  currentFilters = filters;
  resetState();
  fetchPage();
});

document.getElementById('clear').onclick = () => {
  f.reset();
  currentFilters = {};
  resetState();
};

// baca query string jika datang dari *driver detail*
const params = Object.fromEntries(new URLSearchParams(window.location.search).entries());
for (const [k, v] of Object.entries(params)) {
  if (f.elements[k]) f.elements[k].value = v;
}
if (Object.keys(params).length) {
  currentFilters = params;
  resetState();
  fetchPage();
}

window.addEventListener('scroll', () => {
  if (window.innerHeight + window.scrollY >= document.body.offsetHeight - 300) {
    fetchPage();
  }
});
</script>
{% endblock content %}
