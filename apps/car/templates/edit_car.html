{% extends 'base.html' %}

{% block meta %}
    <title>Edit Car Telemetry - SpeedView</title>
    <style>
        .input-field { transition: all 0.3s ease; }
        .input-field:focus { transform: translateY(-1px); }
        .btn-primary { transition: all 0.3s ease; }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(239, 68, 68, 0.25); }
    </style>
{% endblock meta %}

{% block content %}
<div class="edit-car-page px-6 py-10 pb-24 md:px-12">
    <!-- Header -->
    <div class="mb-10">
        <div class="text-sm text-white/60 tracking-wide mb-3 space-x-2">
            <a class="hover:text-red-400" href="{% url 'main:show_main' %}">Home</a>
            <span>&gt;</span>
            <a class="hover:text-red-400" href="{% url 'car:manual_list' %}">Telemetry</a>
            <span>&gt;</span>
            <span class="text-white">Edit Car Telemetry</span>
        </div>
        <h1 class="text-4xl font-bold text-[#E6EDF3] tracking-tight" style="font-family: Alphacorsa, Inter, sans-serif;">Edit Car Telemetry</h1>
        <p class="text-[#E6EDF3]/60 mt-1">Edit data telemetry in SpeedView.</p>
    </div>
    <div class="bg-white rounded-lg border border-gray-200 p-6 sm:p-8 form-style">
      <div class="mb-8">
        <h1 class="text-2xl font-bold text-gray-900 mb-2">Edit Car Telemetry</h1>
        <p class="text-gray-600">Edit data telemetry in SpeedView.</p>
      </div>
      <form id="add-car-form" method="POST" action="{% url 'car:edit_car' car.id %}" class="space-y-6">
        {% csrf_token %}

        <div id="add-car-alerts" class="space-y-3" role="alert"></div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-10">
            <div class="space-y-6">
                {% for field in form.visible_fields %}
                    {% if forloop.counter0|divisibleby:2 %}
                    <div>
                        <label for="{{ field.id_for_label }}" class="block text-sm font-medium text-[#E6EDF3] mb-2">{{ field.label }}</label>
                        <div class="w-full">
                            {{ field }}
                        </div>
                        {% if field.help_text %}
                            <p class="mt-1 text-sm text-[#E6EDF3]/60">{{ field.help_text }}</p>
                        {% endif %}
                        <p class="mt-1 text-sm text-red-400 field-error" data-field="{{ field.name }}"></p>
                    </div>
                    {% endif %}
                {% endfor %}
            </div>
            <div class="space-y-6">
                {% for field in form.visible_fields %}
                    {% if not forloop.counter0|divisibleby:2 %}
                    <div>
                        <label for="{{ field.id_for_label }}" class="block text-sm font-medium text-[#E6EDF3] mb-2">{{ field.label }}</label>
                        <div class="w-full">
                            {{ field }}
                        </div>
                        {% if field.help_text %}
                            <p class="mt-1 text-sm text-[#E6EDF3]/60">{{ field.help_text }}</p>
                        {% endif %}
                        <p class="mt-1 text-sm text-red-400 field-error" data-field="{{ field.name }}"></p>
                    </div>
                    {% endif %}
                {% endfor %}
            </div>
            {% if field.help_text %}
              <p class="mt-1 text-sm text-gray-500">{{ field.help_text }}</p>
            {% endif %}
            <p class="mt-1 text-sm text-red-600 field-error" data-field="{{ field.name }}"></p>
          </div>
        {% endfor %}

        <div class="flex flex-col sm:flex-row gap-4 pt-6 border-t border-gray-200">
          <a href="{% url 'car:manual_list' %}" class="order-2 sm:order-1 px-6 py-3 border border-gray-300 text-gray-700 rounded-md font-medium hover:bg-gray-50 transition-colors text-center">
            Cancel
          </a>
          <button type="submit" class="order-1 sm:order-2 flex-1 bg-green-600 text-white px-6 py-3 rounded-md font-medium hover:bg-green-700 transition-colors">
            Edit Car Telemetry
          </button>
        </div>
      </form>
</div>
</div>
</div>

{{ session_catalog|json_script:"session-catalog-data" }}

<script>
    /* ajax form */
    function setupAjaxForm(formId, alertId, options = {}) {
        const form = document.getElementById(formId);
        if (!form) return;

        form.addEventListener("submit", async (event) => {
            event.preventDefault();
            const alerts = document.getElementById(alertId);
            const submitButton = form.querySelector("button[type='submit']");
            const csrfInput = form.querySelector("[name=csrfmiddlewaretoken]");
            const fieldErrors = form.querySelectorAll(".field-error");

            alerts.innerHTML = "";
            fieldErrors.forEach((el) => (el.textContent = ""));
            submitButton.disabled = true;

            try {
                const response = await fetch(form.action, {
                    method: "POST",
                    headers: {
                        "X-Requested-With": "XMLHttpRequest",
                        "X-CSRFToken": csrfInput ? csrfInput.value : "",
                    },
                    credentials: "same-origin",
                    body: new FormData(form),
                });

                const data = await response.json();

                if (data.success) {
                    if (typeof options.onSuccess === "function") options.onSuccess(data);
                    if (typeof showToast === "function") {
                        showToast("Telemetry saved", data.message || "Car telemetry updated successfully.", "success");
                    }
                } else {
                    if (typeof showToast === "function") {
                        showToast("Telemetry not saved", "Please correct the highlighted fields.", "error");
                    }

                    const generalErrors = [];

                    if (data.errors && typeof data.errors === "object") {
                        Object.entries(data.errors).forEach(([fieldName, messages]) => {
                            const normalizedMessages = Array.isArray(messages) ? messages : [messages];
                            const target = Array.from(fieldErrors).find((el) => el.dataset.field === fieldName);

                            if (target) {
                                target.textContent = normalizedMessages.join(", ");
                            } else {
                                generalErrors.push(
                                    ...normalizedMessages
                                        .map((msg) => (msg === undefined || msg === null ? "" : String(msg)))
                                        .filter((msg) => msg.trim().length > 0)
                                );
                            }
                        });
                    }

                    if (data.error) {
                        generalErrors.push(String(data.error));
                    }
                    if (Array.isArray(data.non_field_errors)) {
                        generalErrors.push(
                            ...data.non_field_errors
                                .map((msg) => (msg === undefined || msg === null ? "" : String(msg)))
                                .filter((msg) => msg.trim().length > 0)
                        );
                    }
                    if (data.message && !data.success) {
                        generalErrors.push(String(data.message));
                    }

                    const uniqueMessages = [...new Set(generalErrors.map((msg) => msg.trim()).filter((msg) => msg.length > 0))];
                    if (uniqueMessages.length) {
                        alerts.innerHTML = `<div class="px-4 py-3 rounded-lg text-sm bg-red-500/10 border border-red-500/50 text-red-400">${uniqueMessages.join("<br>")}</div>`;
                    }

                    if (typeof options.onError === "function") options.onError(data);
                }
            } catch (error) {
                if (typeof showToast === "function") {
                    showToast("Network error", "Something went wrong. Please try again.", "error");
                }
                console.error("AJAX form error:", error);
            } finally {
                submitButton.disabled = false;
            }
        });
    }

    /* widgets + dynamic session options */
    document.addEventListener("DOMContentLoaded", () => {
        const baseInput = "input-field w-full px-4 py-3 bg-[#0D1117] border border-gray-700 rounded-lg text-[#E6EDF3] placeholder-white/40 focus:outline-none focus:ring-2 focus:ring-red-500 focus:border-transparent";
        const baseTextarea = "input-field w-full px-4 py-3 bg-[#0D1117] border border-gray-700 rounded-lg text-[#E6EDF3] placeholder-white/40 focus:outline-none focus:ring-2 focus:ring-red-500 focus:border-transparent";
        const baseSelect = "input-field w-full px-4 py-3 bg-[#0D1117] border border-gray-700 rounded-lg text-[#E6EDF3] focus:outline-none focus:ring-2 focus:ring-red-500 focus:border-transparent";
        const baseCheckbox = "h-4 w-4 rounded accent-red-600 focus:ring-red-500";

        const form = document.getElementById("add-car-form");
        if (form) {
            form.querySelectorAll('input[type="text"], input[type="url"], input[type="number"], input[type="email"], input[type="password"]').forEach(el => { el.className = baseInput; });
            form.querySelectorAll('textarea').forEach(el => { el.className = baseTextarea; });
            form.querySelectorAll('select').forEach(el => { el.className = baseSelect; });
            form.querySelectorAll('input[type="checkbox"]').forEach(el => { el.className = baseCheckbox; });
        }

        const catalogElement = document.getElementById("session-catalog-data");
        const sessionCatalog = catalogElement ? JSON.parse(catalogElement.textContent) : {};
        const meetingSelect = document.querySelector("#add-car-form select[name='meeting_key']");
        const sessionSelect = document.querySelector("#add-car-form select[name='session_key']");
        const defaultPlaceholder = sessionSelect ? sessionSelect.getAttribute("data-placeholder") || "Pilih session" : "Pilih session";
        const emptyPlaceholder = sessionSelect ? sessionSelect.getAttribute("data-empty-placeholder") || "Tidak ada session untuk meeting ini" : "Tidak ada session untuk meeting ini";

        function populateSessionOptions(meetingValue, preserveSelection = true) {
            if (!sessionSelect) return;

            const meetingKey = meetingValue ? String(meetingValue) : "";
            const previousValue = preserveSelection ? sessionSelect.value : "";
            const options = meetingKey ? sessionCatalog[meetingKey] || [] : [];

            sessionSelect.innerHTML = "";

            const placeholderOption = document.createElement("option");
            placeholderOption.value = "";
            placeholderOption.textContent = meetingKey
                ? (options.length ? defaultPlaceholder : emptyPlaceholder)
                : defaultPlaceholder;
            sessionSelect.appendChild(placeholderOption);

            let matched = false;
            options.forEach(({ value, label }) => {
                const option = document.createElement("option");
                option.value = String(value);
                option.textContent = label;
                if (previousValue && String(value) === String(previousValue)) {
                    option.selected = true;
                    matched = true;
                }
                sessionSelect.appendChild(option);
            });

            if (!matched) sessionSelect.selectedIndex = 0;

            if (!meetingKey || options.length === 0) sessionSelect.setAttribute("disabled", "disabled");
            else sessionSelect.removeAttribute("disabled");
        }

        if (meetingSelect && sessionSelect) {
            populateSessionOptions(meetingSelect.value, true);
            meetingSelect.addEventListener("change", (event) => populateSessionOptions(event.target.value, false));
        }
        console.error("AJAX form error:", error);
      } finally {
        submitButton.disabled = false;
      }
    });
  }

  document.addEventListener("DOMContentLoaded", () => {
    const catalogElement = document.getElementById("session-catalog-data");
    const sessionCatalog = catalogElement ? JSON.parse(catalogElement.textContent) : {};
    const meetingSelect = document.querySelector("#add-car-form select[name='meeting_key']");
    const sessionSelect = document.querySelector("#add-car-form select[name='session_key']");
    const defaultPlaceholder = sessionSelect ? sessionSelect.getAttribute("data-placeholder") || "Pilih session" : "Pilih session";
    const emptyPlaceholder =
      sessionSelect ? sessionSelect.getAttribute("data-empty-placeholder") || "Tidak ada session untuk meeting ini" : "Tidak ada session untuk meeting ini";

    function populateSessionOptions(meetingValue, preserveSelection = true) {
      if (!sessionSelect) {
        return;
      }

      const meetingKey = meetingValue ? String(meetingValue) : "";
      const previousValue = preserveSelection ? sessionSelect.value : "";
      const options = meetingKey ? sessionCatalog[meetingKey] || [] : [];

      sessionSelect.innerHTML = "";

      const placeholderOption = document.createElement("option");
      placeholderOption.value = "";
      placeholderOption.textContent = meetingKey
        ? options.length
          ? defaultPlaceholder
          : emptyPlaceholder
        : defaultPlaceholder;
      sessionSelect.appendChild(placeholderOption);

      let matched = false;
      options.forEach(({ value, label }) => {
        const option = document.createElement("option");
        option.value = String(value);
        option.textContent = label;
        if (previousValue && String(value) === String(previousValue)) {
          option.selected = true;
          matched = true;
        }
        sessionSelect.appendChild(option);
      });

      if (!matched) {
        sessionSelect.selectedIndex = 0;
      }

      if (!meetingKey || options.length === 0) {
        sessionSelect.setAttribute("disabled", "disabled");
      } else {
        sessionSelect.removeAttribute("disabled");
      }
    }

    if (meetingSelect && sessionSelect) {
      populateSessionOptions(meetingSelect.value, true);
      meetingSelect.addEventListener("change", (event) => {
        populateSessionOptions(event.target.value, false);
      });
    }

    setupAjaxForm("add-car-form", "add-car-alerts");
  });
</script>
{% endblock %}




