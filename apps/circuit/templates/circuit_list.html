{% extends "base.html" %}
{% load static %}

{% block meta %}
    <title>Circuits – SpeedView</title>
{% endblock meta %}

{% block content %}
<div class="px-6 lg:px-12 py-12 mx-auto">
    <div class="flex items-center justify-between mb-6">
        <div>
            <div class="text-sm text-white/60 tracking-wide mb-3 space-x-2">
                <a class="hover:text-red-400" href="{% url 'main:show_main' %}">Home</a>
                <span>›</span> 
                <span class="text-white">Circuit</span>
            </div>
            <h1 class="mt-1 text-4xl font-bold text-white" style="font-family: Alphacorsa, Inter, sans-serif;">
                Circuits
            </h1>
        </div>
        <div class="flex items-center gap-3">
            <div class="relative">
                <form id="search-form" class="relative">
                    {% csrf_token %} 
                    <input
                        id="circuit-search"
                        type="text"
                        placeholder="Search circuit..."
                        class="w-64 md:w-72 px-4 py-2.5 rounded-lg bg-[#0D1117] border border-white/10 text-white placeholder-white/40 focus:outline-none focus:ring-2 focus:ring-red-500 focus:border-transparent"
                        autocomplete="off"
                    />
                    <svg class="absolute right-3 top-1/2 -translate-y-1/2 w-5 h-5 text-white/50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m21 21-4.35-4.35M11 19a8 8 0 1 1 0-16 8 8 0 0 1 0 16z"/>
                    </svg>
                </form>
            </div>
            {% if request.user.is_authenticated and request.user.profile.role == 'admin' %}
                <a href="{% url 'circuit:add_page' %}"
                   class="inline-flex items-center gap-2 px-4 py-2.5 rounded-lg bg-red-600 text-white font-semibold hover:bg-red-700 transition">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16M4 12h16"/>
                    </svg>
                    Add Circuit
                </a>
            {% endif %}
        </div>
    </div>

    <p id="results-info" class="text-sm text-white/60 mb-4">Loading circuits…</p>

    <div id="grid" class="grid gap-5 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4">
    </div>

    <template id="card-template">
        <div class="group flex flex-col rounded-xl bg-[#0D1117]/80 border border-white/10 hover:border-red-500/50 transition overflow-hidden">
            <a class="card-link" href="#">
                <div class="bg-white p-2 rounded-t-lg"> 
                    <img class="card-img w-full h-40 object-contain" alt="Circuit map" /> 
                </div>
            </a>
            <div class="p-4 flex flex-col flex-grow">
                <a class="card-link" href="#">
                    <h3 class="card-name truncate text-lg font-semibold text-white group-hover:text-red-400 transition"></h3>
                </a>
                <p class="card-location text-sm text-white/60 truncate"></p>
                
                <div class="mt-auto pt-3">
                {% if request.user.is_authenticated and request.user.profile.role == 'admin' %}
                    <div class="flex justify-end items-center gap-4 mt-3 border-t border-white/10 pt-3">
                        <a class="edit-link text-xs font-semibold text-yellow-400 hover:text-yellow-300" href="#">EDIT</a>
                        <form class="delete-form contents" method="POST" action="#">
                            {% csrf_token %}
                            <button type="button" class="open-delete-modal text-xs font-semibold text-red-400 hover:text-red-300">DELETE</button>
                        </form>
                    </div>
                {% endif %}
                </div>
            </div>
        </div>
    </template>
</div>

<!-- Modal Delete -->
<div id="delete-modal" class="fixed inset-0 z-50 hidden">
    <div id="modal-backdrop" class="absolute inset-0 bg-black/60"></div>
    <div class="absolute inset-0 flex items-center justify-center px-4">
        <div class="w-full max-w-md rounded-2xl bg-[#0B0F14] border border-white/10 shadow-xl">
            <div class="p-5 border-b border-white/10">
                <h3 class="text-white text-lg font-semibold">Delete Circuit</h3>
            </div>
            <div class="p-5 space-y-3">
                <p class="text-white/80">Are you sure you want to delete <span id="modal-circuit-name" class="font-semibold text-white"></span>?</p>
                <p class="text-white/60 text-sm">This action cannot be undone.</p>
                <div id="modal-error" class="hidden text-red-400 text-sm"></div>
            </div>
            <div class="px-5 pb-5 pt-2 flex items-center justify-end gap-2">
                <button id="modal-cancel" type="button" class="px-3 py-2 rounded-lg bg-white/10 border border-white/15 text-white/90 hover:bg-white/15 transition">Cancel</button>
                <button id="modal-confirm" type="button" class="px-3 py-2 rounded-lg bg-red-600 text-white font-semibold hover:bg-red-700 transition">Delete</button>
            </div>
        </div>
    </div>
</div>


<script>
    document.addEventListener('DOMContentLoaded', function() {
        // === VARIABEL ===
        const API_LIST_URL = "{% url 'circuit:api_list' %}";
        const grid = document.getElementById("grid");
        const searchInput = document.getElementById("circuit-search");
        const resultsInfo = document.getElementById("results-info");
        const cardTemplate = document.getElementById("card-template");
        
        const deleteModal = document.getElementById('delete-modal');
        const modalBackdrop = document.getElementById('modal-backdrop');
        const modalCancel = document.getElementById('modal-cancel');
        const modalConfirm = document.getElementById('modal-confirm');
        const modalCircuitName = document.getElementById('modal-circuit-name');
        const modalError = document.getElementById('modal-error');
        const _csrfToken = document.querySelector("#search-form [name='csrfmiddlewaretoken']").value;

        let allCircuits = [];

        // === FUNGSI ===
        function renderCards(circuits) {
            grid.innerHTML = "";
            if (!circuits.length) {
                grid.innerHTML = `<div class="col-span-full text-center text-white/60 p-8 bg-white/5 rounded-lg">No circuits match your search.</div>`;
                return;
            }

            circuits.forEach(c => {
                const card = cardTemplate.content.firstElementChild.cloneNode(true);             
                card.querySelector('.card-name').textContent = c.name;
                card.querySelector('.card-location').textContent = `${c.location}, ${c.country}`;
                const img = card.querySelector('.card-img');
                img.src = c.map_image_url || 'https://placehold.co/600x400/0D1117/E6EDF3?text=No+Map';
                img.alt = `Map of ${c.name}`;
                img.onerror = () => { img.src = 'https://placehold.co/600x400/0D1117/E6EDF3?text=No+Map'; };
                card.querySelectorAll('.card-link').forEach(link => link.href = c.detail_url);
                const editLink = card.querySelector('.edit-link');
                const deleteButton = card.querySelector('.open-delete-modal');
                if (c.is_admin && editLink && deleteButton) {
                    editLink.href = c.edit_url;                     
                    deleteButton.dataset.name = c.name;
                    deleteButton.dataset.url = c.delete_url;
                } else if (!c.is_admin) {
                    const adminActions = card.querySelector('.mt-auto .flex');
                    if(adminActions) adminActions.remove();
                }                
                grid.appendChild(card);
            });
        }

        function applyFilter() {
            const query = searchInput.value.trim().toLowerCase();
            const filteredCircuits = allCircuits.filter(c => 
                c.name.toLowerCase().includes(query) ||
                c.country.toLowerCase().includes(query) ||
                c.location.toLowerCase().includes(query)
            );
            renderCards(filteredCircuits);
            resultsInfo.textContent = `${filteredCircuits.length} of ${allCircuits.length} circuits shown`;
        }

        async function fetchCircuits() {
            try {
                const response = await fetch(API_LIST_URL);
                const result = await response.json();
                if (result.ok) {
                    allCircuits = result.data;
                    applyFilter();
                } else {
                    throw new Error(result.error || "Failed to fetch data.");
                }
            } catch (error) {
                grid.innerHTML = `<div class="col-span-full text-center text-red-400 p-8 bg-red-500/10 rounded-lg">${error.message}</div>`;
                resultsInfo.textContent = "Could not load circuits.";
            }
        }
        
        function closeModal() {
            deleteModal.classList.add('hidden');
            modalError.classList.add('hidden');
            modalError.textContent = '';
        }

        // === EVENT LISTENERS ===
        grid.addEventListener('click', (e) => {
            const deleteButton = e.target.closest('.open-delete-modal');
            if (deleteButton) {
                e.preventDefault();
                const circuitName = deleteButton.dataset.name;
                const deleteUrl = deleteButton.dataset.url;
                
                modalCircuitName.textContent = circuitName;
                modalConfirm.dataset.deleteUrl = deleteUrl;
                deleteModal.classList.remove('hidden');
            }
        });

        modalCancel.addEventListener('click', closeModal);
        modalBackdrop.addEventListener('click', closeModal);
        modalConfirm.addEventListener('click', async () => {
            const deleteUrl = modalConfirm.dataset.deleteUrl;
            if (!deleteUrl) return;

            modalConfirm.disabled = true;
            modalError.classList.add('hidden');
            
            try {
                const response = await fetch(deleteUrl, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': _csrfToken,
                        'Accept': 'application/json'
                    }
                });

                if (response.ok) {
                    closeModal();
                    fetchCircuits(); 
                } else {
                    const data = await response.json();
                    modalError.textContent = data.error || 'Failed to delete circuit.';
                    modalError.classList.remove('hidden');
                }
            } catch (err) {
                modalError.textContent = 'An error occurred. Check your connection.';
                modalError.classList.remove('hidden');
            } finally {
                modalConfirm.disabled = false;
            }
        });
        searchInput.addEventListener('input', applyFilter);        
        fetchCircuits();
    });
</script>
{% endblock content %}