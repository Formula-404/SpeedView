{% extends "base.html" %}
{% load static %}

{% block meta %}
    <title>Team Comparison – SpeedView</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{% endblock meta %}

{% block content %}
<div class="px-12 py-12 mx-auto">
    <!-- Header -->
    <div class="text-sm text-white/60 tracking-wide mb-3 space-x-2">
        <a class="hover:text-red-400" href="{% url 'main:show_main' %}">Home</a>
        <span>›</span>
        <a class="hover:text-red-400" href="{% url 'comparison:create_page' %}">Compare</a>
        <span>›</span>
        <span class="text-white">Teams</span>
    </div>
    <h1 class="text-4xl font-bold text-white">Team Comparison</h1>
    <p class="text-white/60 mt-1">Up to 4 teams, factual overview and a radar stats diagram.</p>

    <!-- Selection summary -->
    <div class="mt-6 grid gap-4 sm:grid-cols-2 lg:grid-cols-4">
        {% for t in teams %}
        <a href="{{ t.get_absolute_url }}" class="rounded-xl bg-white/5 border border-white/10 p-4 flex items-center gap-3 hover:border-red-500/40">
            <img src="{{ t.team_logo_url }}" alt="{{ t.team_name }}" class="h-9 w-9 rounded bg-white/10 object-contain" onerror="this.src='https://www.edigitalagency.com.au/wp-content/uploads/F1-logo-png-medium-size.png'">
            <div class="min-w-0">
                <div class="text-white font-semibold truncate">{{ t.team_name }}</div>
                <div class="text-xs text-white/60 truncate">{{ t.country }}{% if t.base %} • {{ t.base }}{% endif %}</div>
            </div>
        </a>
        {% endfor %}
    </div>

    <!-- Facts table -->
    <div class="mt-8 rounded-2xl bg-[#0D1117]/80 border border-white/10 p-6">
        <h2 class="text-white text-lg font-semibold mb-4">Overview</h2>
        <div class="overflow-x-auto">
            <table class="min-w-full text-sm">
                <thead class="text-white/60">
                    <tr>
                        <th class="text-left py-2 pr-4">Attribute</th>
                        {% for t in teams %}
                        <th class="text-left py-2 px-4">{{ t.team_name }}</th>
                        {% endfor %}
                    </tr>
                </thead>
                <tbody class="text-white/90">
                    <tr class="border-t border-white/10">
                        <td class="py-2 pr-4">Founded</td>
                        {% for t in teams %}<td class="py-2 px-4">{{ t.founded_year|default:"—" }}</td>{% endfor %}
                    </tr>
                    <tr class="border-t border-white/10">
                        <td class="py-2 pr-4">Engines</td>
                        {% for t in teams %}<td class="py-2 px-4">{{ t.engines|default:"—" }}</td>{% endfor %}
                    </tr>
                    <tr class="border-t border-white/10">
                        <td class="py-2 pr-4">Website</td>
                        {% for t in teams %}
                            <td class="py-2 px-4">
                                {% if t.website %}<a class="text-red-400 hover:text-red-300 underline" href="{{ t.website }}" target="_blank" rel="noopener">Visit</a>{% else %}—{% endif %}
                            </td>
                        {% endfor %}
                    </tr>
                    <tr class="border-t border-white/10">
                        <td class="py-2 pr-4">Races entered</td>
                        {% for t in teams %}<td class="py-2 px-4">{{ t.races_entered }}</td>{% endfor %}
                    </tr>
                    <tr class="border-t border-white/10">
                        <td class="py-2 pr-4">Wins</td>
                        {% for t in teams %}<td class="py-2 px-4">{{ t.race_victories }}</td>{% endfor %}
                    </tr>
                    <tr class="border-t border-white/10">
                        <td class="py-2 pr-4">Podiums</td>
                        {% for t in teams %}<td class="py-2 px-4">{{ t.podiums }}</td>{% endfor %}
                    </tr>
                    <tr class="border-t border-white/10">
                        <td class="py-2 pr-4">Points</td>
                        {% for t in teams %}<td class="py-2 px-4">{{ t.points }}</td>{% endfor %}
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- Radar -->
    <div class="mt-8 rounded-2xl bg-[#0D1117]/80 border border-white/10 p-6">
        <h2 class="text-white text-lg font-semibold mb-4">Stats Diagram</h2>
        <canvas id="radar" height="140"></canvas>
        <div class="mt-3 text-xs text-white/50">Times are inverted for scoring (lower is better).</div>
    </div>
</div>

<script>
    (function() {
        /* data from Django context */
        const teams = [
            {% for t in teams %}
            {
                name: "{{ t.team_name|escapejs }}",
                color: "#{{ t.team_colour }}",
                avg_lap_time_ms: {{ t.avg_lap_time_ms|default:"null" }},
                best_lap_time_ms: {{ t.best_lap_time_ms|default:"null" }},
                avg_pit_duration_ms: {{ t.avg_pit_duration_ms|default:"null" }},
                top_speed_kph: {{ t.top_speed_kph|default:"null" }},
                laps_completed: {{ t.laps_completed|default:"0" }},
            },
            {% endfor %}
        ];

        /* metrics */
        const METRICS = [
            { key: "avg_lap_time_ms", label: "Avg lap (ms)", invert: true },
            { key: "best_lap_time_ms", label: "Best lap (ms)", invert: true },
            { key: "avg_pit_duration_ms", label: "Avg pit (ms)", invert: true },
            { key: "top_speed_kph", label: "Top speed (kph)", invert: false },
            { key: "laps_completed", label: "Laps completed", invert: false },
        ];

        /* normalize 0..100 with optional inversion */
        function normalize(values, invert=false) {
            const nums = values.filter(v => v !== null && v !== undefined);
            if (!nums.length) return values.map(_ => null);
            const min = Math.min(...nums);
            const max = Math.max(...nums);
            if (max === min) return values.map(v => (v == null ? null : 50));
            return values.map(v => {
                if (v == null) return null;
                const n = (v - min) / (max - min);
                const s = invert ? (1 - n) : n;
                return Math.round(s * 100);
            });
        }

        const labels = METRICS.map(m => m.label);
        const datasets = [];
        METRICS.forEach((m, mi) => {
            /* gather per team per metric */
        });

        const scoresByTeam = teams.map(t => {
            return {
                name: t.name,
                color: t.color || "#e11d48",
                values: METRICS.map(m => t[m.key])
            };
        });

        const cols = scoresByTeam.map(s => s.values); // team -> metrics values
        const perMetric = METRICS.map((m, i) => cols.map(row => row[i]));
        const perMetricNorm = perMetric.map((arr, i) => normalize(arr, METRICS[i].invert));

        const teamDatasets = scoresByTeam.map((team, ti) => {
            const vals = perMetricNorm.map(arr => arr[ti] ?? 0);
            return {
                label: team.name,
                data: vals,
                borderColor: team.color,
                backgroundColor: team.color + "33",
                pointBackgroundColor: team.color,
                pointBorderColor: "#fff",
            };
        });

        const ctx = document.getElementById("radar").getContext("2d");
        new Chart(ctx, {
            type: "radar",
            data: {
                labels,
                datasets: teamDatasets
            },
            options: {
                responsive: true,
                plugins: {
                    legend: { labels: { color: "#fff" } },
                    tooltip: {
                        callbacks: {
                            label: (ctx) => `${ctx.dataset.label}: ${ctx.formattedValue}`
                        }
                    }
                },
                scales: {
                    r: {
                        angleLines: { color: "rgba(255,255,255,0.15)" },
                        grid: { color: "rgba(255,255,255,0.15)" },
                        pointLabels: { color: "#fff" },
                        suggestedMin: 0,
                        suggestedMax: 100,
                        ticks: { display: false }
                    }
                }
            }
        });
    })();
</script>
{% endblock content %}
