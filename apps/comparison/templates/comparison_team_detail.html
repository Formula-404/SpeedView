{% extends "base.html" %}
{% load static %}

{% block meta %}
    <title>{{ cmp.title|default:"Team Comparison" }} – SpeedView</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
    .icon-btn { display:inline-flex; align-items:center; justify-content:center; padding:6px; border-radius:10px; background:rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.12); transition:transform .15s ease, background .15s ease, border-color .15s ease; }
    .icon-btn:hover { transform:translateY(-1px); background:rgba(255,255,255,.1); border-color:rgba(255,255,255,.2); }
    .icon-btn img { width:18px; height:18px; display:block; }
    .gap-x-1_5 { column-gap: .375rem; }
</style>
{% endblock meta %}

{% block content %}
<div class="px-12 py-12 mx-auto">
    <!-- header -->
    <div class="mb-6">
        <div class="text-sm text-white/60 tracking-wide mb-3 space-x-2">
            <a class="hover:text-red-400" href="{% url 'main:show_main' %}">Home</a>
            <span>›</span>
            <a class="hover:text-red-400" href="{% url 'comparison:list_page' %}">Comparison</a>
            <span>›</span>
            <span class="text-white">{{ cmp.title|default:"Team Comparison" }}</span>
        </div>

        <div class="flex items-start gap-4">
            <div class="min-w-0">
                <h1 class="text-4xl font-bold text-white truncate">{{ cmp.title|default:"Team Comparison" }}</h1>
                <p class="text-white/60 mt-1">Up to 4 teams, factual overview and a radar stats diagram.</p>
            </div>

            <div class="ml-auto flex items-center gap-x-1_5">
                {% if request.user.is_authenticated %}
                    {% if request.user == cmp.owner or request.user.profile.role == "admin" %}
                        {% comment %} <a id="cmp-edit-link"
                        href="{% url 'comparison:create_page' %}?edit={{ cmp.id }}&module={{ cmp.module }}"
                        class="icon-btn" title="Edit">
                            <img alt="Edit" src="https://img.icons8.com/?size=100&id=kCViyr9hZtLX&format=png&color=FFFFFF" />
                        </a> {% endcomment %}
                        <button id="cmp-delete-btn" type="button" class="icon-btn" title="Delete">
                            <img alt="Delete" src="https://img.icons8.com/?size=100&id=85194&format=png&color=FFFFFF" />
                        </button>
                    {% endif %}
                {% endif %}
            </div>
        </div>
    </div>

    <!-- selection summary -->
    <div class="mt-6 grid gap-4 sm:grid-cols-2 lg:grid-cols-4">
        {% for t in teams %}
        <a href="{{ t.get_absolute_url }}" class="rounded-xl bg-white/5 border border-white/10 p-4 flex items-center gap-3 hover:border-red-500/40">
            <img src="{{ t.team_logo_url }}" alt="{{ t.team_name }}" class="h-9 w-9 rounded bg-white/10 object-contain" onerror="this.src='https://www.edigitalagency.com.au/wp-content/uploads/F1-logo-png-medium-size.png'">
            <div class="min-w-0">
                <div class="text-white font-semibold truncate">{{ t.team_name }}</div>
                <div class="text-xs text-white/60 truncate">{{ t.country }}{% if t.base %} • {{ t.base }}{% endif %}</div>
            </div>
        </a>
        {% endfor %}
    </div>

    <!-- facts table -->
    <div class="mt-8 rounded-2xl bg-[#0D1117]/80 border border-white/10 p-6">
        <h2 class="text-white text-lg font-semibold mb-4">Overview</h2>
        <div class="overflow-x-auto">
            <table class="min-w-full text-sm">
                <thead class="text-white/60">
                    <tr>
                        <th class="text-left py-2 pr-4">Attribute</th>
                        {% for t in teams %}
                        <th class="text-left py-2 px-4">{{ t.team_name }}</th>
                        {% endfor %}
                    </tr>
                </thead>
                <tbody class="text-white/90">
                    <tr class="border-t border-white/10">
                        <td class="py-2 pr-4">Founded</td>
                        {% for t in teams %}<td class="py-2 px-4">{{ t.founded_year|default:"—" }}</td>{% endfor %}
                    </tr>
                    <tr class="border-t border-white/10">
                        <td class="py-2 pr-4">Engines</td>
                        {% for t in teams %}<td class="py-2 px-4">{{ t.engines|default:"—" }}</td>{% endfor %}
                    </tr>
                    <tr class="border-t border-white/10">
                        <td class="py-2 pr-4">Website</td>
                        {% for t in teams %}
                            <td class="py-2 px-4">
                                {% if t.website %}<a class="text-red-400 hover:text-red-300 underline" href="{{ t.website }}" target="_blank" rel="noopener">Visit</a>{% else %}—{% endif %}
                            </td>
                        {% endfor %}
                    </tr>
                    <tr class="border-t border-white/10">
                        <td class="py-2 pr-4">Races entered</td>
                        {% for t in teams %}<td class="py-2 px-4">{{ t.races_entered }}</td>{% endfor %}
                    </tr>
                    <tr class="border-t border-white/10">
                        <td class="py-2 pr-4">Wins</td>
                        {% for t in teams %}<td class="py-2 px-4">{{ t.race_victories }}</td>{% endfor %}
                    </tr>
                    <tr class="border-t border-white/10">
                        <td class="py-2 pr-4">Podiums</td>
                        {% for t in teams %}<td class="py-2 px-4">{{ t.podiums }}</td>{% endfor %}
                    </tr>
                    <tr class="border-t border-white/10">
                        <td class="py-2 pr-4">Points</td>
                        {% for t in teams %}<td class="py-2 px-4">{{ t.points }}</td>{% endfor %}
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- radar -->
    <div class="mt-8 rounded-2xl bg-[#0D1117]/80 border border-white/10 p-6">
        <h2 class="text-white text-lg font-semibold mb-4">Stats Diagram</h2>
        <canvas id="radar" height="140"></canvas>
        <div class="mt-3 text-xs text-white/50">Times are inverted for scoring (lower is better).</div>
    </div>
</div>

<div id="cmp-delete-modal" class="fixed inset-0 z-50 hidden">
    <div id="cmp-modal-backdrop" class="absolute inset-0 bg-black/60"></div>
    <div class="absolute inset-0 flex items-center justify-center px-4">
        <div class="w-full max-w-md rounded-2xl bg-[#0B0F14] border border-white/10 shadow-xl">
            <div class="p-5 border-b border-white/10">
                <h3 class="text-white text-lg font-semibold">Delete Comparison</h3>
            </div>
            <div class="p-5 space-y-3">
                <p class="text-white/80">Are you sure you want to delete <span class="font-semibold text-white">{{ cmp.title }}</span>?</p>
                <p class="text-white/60 text-sm">This action cannot be undone.</p>
                <div id="cmp-modal-error" class="hidden text-red-400 text-sm"></div>
            </div>
            <div class="px-5 pb-5 pt-2 flex items-center justify-end gap-2">
                <button id="cmp-modal-cancel" type="button" class="px-3 py-2 rounded-lg bg-white/10 border border-white/15 text-white/90 hover:bg-white/15 transition">Cancel</button>
                <button id="cmp-modal-confirm" type="button" class="px-3 py-2 rounded-lg bg-red-600 text-white font-semibold hover:bg-red-700 transition">Delete</button>
            </div>
        </div>
    </div>
</div>

<script>
    (function() {
        const teams = [
            {% for t in teams %}
            {
                name: "{{ t.team_name|escapejs }}",
                color: "#{{ t.team_colour }}",
                avg_lap_time_ms: {{ t.avg_lap_time_ms|default:"null" }},
                best_lap_time_ms: {{ t.best_lap_time_ms|default:"null" }},
                avg_pit_duration_ms: {{ t.avg_pit_duration_ms|default:"null" }},
                top_speed_kph: {{ t.top_speed_kph|default:"null" }},
                laps_completed: {{ t.laps_completed|default:"null" }},
            },
            {% endfor %}
        ];

        const METRICS = [
            { key: "avg_lap_time_ms", label: "Avg lap (ms)", invert: true },
            { key: "best_lap_time_ms", label: "Best lap (ms)", invert: true },
            { key: "avg_pit_duration_ms", label: "Avg pit (ms)", invert: true },
            { key: "top_speed_kph", label: "Top speed (kph)", invert: false },
            { key: "laps_completed", label: "Laps completed", invert: false },
        ];

        const DOMAIN = {
            avg_lap_time_ms: [60000, 120000],
            best_lap_time_ms: [55000, 100000],
            avg_pit_duration_ms: [1500, 4000],
            top_speed_kph: [250, 400],
            laps_completed: [0, 10000],
        };

        function clamp01(x) { return x < 0 ? 0 : x > 1 ? 1 : x; }
        function normalizeFixed(value, key, invert) {
            if (value == null) return null;
            const [lo, hi] = DOMAIN[key] || [0, 1];
            if (hi === lo) return 50;
            const t = clamp01((value - lo) / (hi - lo));
            return Math.round((invert ? 1 - t : t) * 100);
        }

        const rows = teams.map(t => ({
            name: t.name,
            color: t.color || "#e11d48",
            raw: METRICS.map(m => t[m.key])
        }));

        const normalized = rows.map(r => METRICS.map(m => normalizeFixed(r.raw[METRICS.indexOf(m)], m.key, m.invert)));

        const datasets = rows.map((r, i) => ({
            label: r.name,
            data: normalized[i].map(v => v === null ? null : v),
            borderColor: r.color,
            backgroundColor: r.color + "33",
            pointBackgroundColor: r.color,
            pointBorderColor: "#fff",
        }));

        const ctx = document.getElementById("radar").getContext("2d");
        new Chart(ctx, {
            type: "radar",
            data: {
                labels: METRICS.map(m => m.label),
                datasets
            },
            options: {
                responsive: true,
                elements: { line: { spanGaps: true } },
                plugins: {
                    legend: { labels: { color: "#fff" } },
                    tooltip: {
                        callbacks: {
                            label: function(c) {
                                const team = rows[c.datasetIndex];
                                const metric = METRICS[c.dataIndex];
                                const raw = team.raw[c.dataIndex];
                                if (raw == null) return `${team.name}: no data`;
                                return `${team.name}: ${raw} (score ${c.formattedValue})`;
                            }
                        }
                    }
                },
                scales: {
                    r: {
                        angleLines: { color: "rgba(255,255,255,0.15)" },
                        grid: { color: "rgba(255,255,255,0.15)" },
                        pointLabels: { color: "#fff" },
                        suggestedMin: 0,
                        suggestedMax: 100,
                        ticks: { display: false }
                    }
                }
            }
        });
    })();
    (function() {
        function getCSRF() {
            const name = "csrftoken=";
            return document.cookie.split(";").map(s => s.trim()).find(s => s.startsWith(name))?.slice(name.length) || "";
        }

        const delBtn = document.getElementById("cmp-delete-btn");
        const modal = document.getElementById("cmp-delete-modal");
        const backdrop = document.getElementById("cmp-modal-backdrop");
        const cancelBtn = document.getElementById("cmp-modal-cancel");
        const confirmBtn = document.getElementById("cmp-modal-confirm");
        const errorBox = document.getElementById("cmp-modal-error");
        const API_DELETE = "{% url 'comparison:api_delete' pk=cmp.pk %}";

        function openModal() {
            modal.classList.remove("hidden");
            errorBox.classList.add("hidden");
            confirmBtn.disabled = false;
            confirmBtn.textContent = "Delete";
        }
        function closeModal() {
            modal.classList.add("hidden");
        }

        if (delBtn) delBtn.addEventListener("click", openModal);
        if (cancelBtn) cancelBtn.addEventListener("click", closeModal);
        if (backdrop) backdrop.addEventListener("click", closeModal);
        document.addEventListener("keydown", (e) => {
            if (!modal.classList.contains("hidden") && e.key === "Escape") closeModal();
        });

        if (confirmBtn) {
            confirmBtn.addEventListener("click", async () => {
                confirmBtn.disabled = true;
                confirmBtn.textContent = "Deleting…";
                errorBox.classList.add("hidden");
                try {
                    const res = await fetch(API_DELETE, {
                        method: "POST",
                        headers: {
                            "X-Requested-With": "XMLHttpRequest",
                            "X-CSRFToken": getCSRF(),
                            "Accept": "application/json"
                        },
                        credentials: "same-origin"
                    });
                    const json = await res.json().catch(() => ({}));
                    if (!res.ok || json.ok === false) {
                        errorBox.textContent = json.error || `Failed to delete (status ${res.status}).`;
                        errorBox.classList.remove("hidden");
                        confirmBtn.disabled = false;
                        confirmBtn.textContent = "Delete";
                        return;
                    }
                    window.location.href = json.redirect || "{% url 'comparison:list_page' %}";
                } catch (e) {
                    errorBox.textContent = "Network error while deleting. Please try again.";
                    errorBox.classList.remove("hidden");
                    confirmBtn.disabled = false;
                    confirmBtn.textContent = "Delete";
                }
            });
        }
    })();
</script>
{% endblock content %}
