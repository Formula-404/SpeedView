{% extends "base.html" %}
{% load static %}

{% block meta %}
    <title>{{ cmp.title|default:"Car Comparison" }} – SpeedView</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .icon-btn { display:inline-flex; align-items:center; justify-content:center; padding:6px; border-radius:10px; background:rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.12); transition:transform .15s ease, background .15s ease, border-color .15s ease; }
        .icon-btn:hover { transform:translateY(-1px); background:rgba(255,255,255,.1); border-color:rgba(255,255,255,.2); }
        .icon-btn img { width:18px; height:18px; display:block; }
        .gap-x-1_5 { column-gap: .375rem; }
    </style>
{% endblock meta %}

{% block content %}
<div class="px-12 py-12 mx-auto">
    <div class="mb-6">
        <div class="text-sm text-white/60 tracking-wide mb-3 space-x-2">
            <a class="hover:text-red-400" href="{% url 'main:show_main' %}">Home</a>
            <span>›</span>
            <a class="hover:text-red-400" href="{% url 'comparison:list_page' %}">Comparison</a>
            <span>›</span>
            <span class="text-white">{{ cmp.title|default:"Car Comparison" }}</span>
        </div>

        <div class="flex items-start gap-4">
            <div class="min-w-0">
                <h1 class="text-4xl font-bold text-white truncate">{{ cmp.title|default:"Car Comparison" }}</h1>
                <p class="text-white/60 mt-1">Overlay telemetry by car group. Choose metric to compare speed, RPM, or throttle.</p>
            </div>

            <div class="ml-auto flex items-center gap-x-1_5">
                {% if request.user.is_authenticated %}
                    {% if request.user == cmp.owner or request.user.profile.role == "admin" %}
                        <button id="cmp-delete-btn" type="button" class="icon-btn" title="Delete">
                            <img alt="Delete" src="https://img.icons8.com/?size=100&id=85194&format=png&color=FFFFFF" />
                        </button>
                    {% endif %}
                {% endif %}
            </div>
        </div>
    </div>

    <div class="mt-6 grid gap-4 sm:grid-cols-2 lg:grid-cols-4">
        {% for c in cars %}
        <div class="rounded-xl bg-white/5 border border-white/10 p-4 flex items-center gap-3">
            <div class="h-9 w-9 rounded bg-white/10 flex items-center justify-center text-white/80 text-sm font-semibold">#{{ c.driver_number|default:"—" }}</div>
            <div class="min-w-0">
                <div class="text-white font-semibold truncate">
                    Driver {{ c.driver_number|default:"—" }}
                </div>
                <div class="text-xs text-white/60 truncate">
                    {% if c.meeting_key %}Meeting {{ c.meeting_key }}{% else %}—{% endif %}
                    {% if c.session_key %} • Session {{ c.session_key }}{% endif %}
                </div>
            </div>
        </div>
        {% endfor %}
    </div>

    <div class="mt-8 rounded-2xl bg-[#0D1117]/80 border border-white/10 p-6">
        <div class="flex items-center justify-between mb-4">
            <h2 class="text-white text-lg font-semibold">Telemetry</h2>
            <div class="flex items-center gap-2">
                <label for="metric" class="text-white/70 text-sm">Metric</label>
                <select id="metric" class="bg-[#0B0F14] border border-white/15 text-white/90 text-sm rounded-lg px-2 py-1">
                    <option value="speed">Speed</option>
                    <option value="rpm">RPM</option>
                    <option value="throttle">Throttle</option>
                </select>
            </div>
        </div>
        <canvas id="carLine" height="180"></canvas>
        <div class="mt-3 text-xs text-white/50">Each line represents one car group (driver, meeting, session). X axis is timestamp order.</div>
    </div>
</div>

<div id="cmp-delete-modal" class="fixed inset-0 z-50 hidden">
    <div id="cmp-modal-backdrop" class="absolute inset-0 bg-black/60"></div>
    <div class="absolute inset-0 flex items-center justify-center px-4">
        <div class="w-full max-w-md rounded-2xl bg-[#0B0F14] border border-white/10 shadow-xl">
            <div class="p-5 border-b border-white/10">
                <h3 class="text-white text-lg font-semibold">Delete Comparison</h3>
            </div>
            <div class="p-5 space-y-3">
                <p class="text-white/80">Are you sure you want to delete <span class="font-semibold text-white">{{ cmp.title }}</span>?</p>
                <p class="text-white/60 text-sm">This action cannot be undone.</p>
                <div id="cmp-modal-error" class="hidden text-red-400 text-sm"></div>
            </div>
            <div class="px-5 pb-5 pt-2 flex items-center justify-end gap-2">
                <button id="cmp-modal-cancel" type="button" class="px-3 py-2 rounded-lg bg-white/10 border border-white/15 text-white/90 hover:bg-white/15 transition">Cancel</button>
                <button id="cmp-modal-confirm" type="button" class="px-3 py-2 rounded-lg bg-red-600 text-white font-semibold hover:bg-red-700 transition">Delete</button>
            </div>
        </div>
    </div>
</div>

<script>
    (function() {
        const groups = [
            {% for c in cars %}
            {
                driver_number: {{ c.driver_number|default:"null" }},
                meeting_key: {{ c.meeting_key|default:"null" }},
                session_key: {{ c.session_key|default:"null" }}
            },
            {% endfor %}
        ].filter(g => g.driver_number !== null && g.meeting_key !== null && g.session_key !== null);

        const palette = ["#ef4444","#3b82f6","#22c55e","#a855f7","#f59e0b","#14b8a6","#eab308","#10b981"];
        const metricSel = document.getElementById("metric");
        const ctx = document.getElementById("carLine").getContext("2d");

        let chart;

        async function fetchGroup(g, metric) {
            const params = new URLSearchParams({
                metric: metric,
                driver_number: String(g.driver_number),
                meeting_key: String(g.meeting_key),
                session_key: String(g.session_key)
            });
            const res = await fetch("{% url 'car:api_grouped' %}?" + params.toString(), { credentials: "same-origin" });
            const json = await res.json();
            if (!json.ok) return null;
            const grp = (json.groups || [])[0];
            if (!grp) return null;
            const telemetry = grp.telemetry || [];
            const xs = telemetry.map((t, i) => i);
            const ys = telemetry.map(t => t[metric] ?? null);
            return { label: `#${g.driver_number} M${g.meeting_key} S${g.session_key}`, xs, ys };
        }

        async function render(metric) {
            const results = await Promise.all(groups.map(g => fetchGroup(g, metric)));
            const datasets = [];
            let longest = 0;
            results.forEach((r, i) => {
                if (!r) return;
                if (r.xs.length > longest) longest = r.xs.length;
                const color = palette[i % palette.length];
                datasets.push({
                    label: r.label,
                    data: r.ys,
                    borderColor: color,
                    backgroundColor: color + "22",
                    pointRadius: 0,
                    borderWidth: 2,
                    tension: 0.15
                });
            });
            const labels = Array.from({ length: longest }, (_, i) => i);
            if (chart) chart.destroy();
            chart = new Chart(ctx, {
                type: "line",
                data: { labels, datasets },
                options: {
                    responsive: true,
                    animation: false,
                    scales: {
                        x: {
                            grid: { color: "rgba(255,255,255,0.15)" },
                            ticks: { color: "#fff" }
                        },
                        y: {
                            grid: { color: "rgba(255,255,255,0.15)" },
                            ticks: { color: "#fff" }
                        }
                    },
                    plugins: {
                        legend: { labels: { color: "#fff" } },
                        tooltip: { intersect: false, mode: "index" }
                    }
                }
            });
        }

        metricSel.addEventListener("change", () => render(metricSel.value));
        render(metricSel.value);
    })();

    (function() {
        function getCSRF() {
            const name = "csrftoken=";
            return document.cookie.split(";").map(s => s.trim()).find(s => s.startsWith(name))?.slice(name.length) || "";
        }

        const delBtn = document.getElementById("cmp-delete-btn");
        const modal = document.getElementById("cmp-delete-modal");
        const backdrop = document.getElementById("cmp-modal-backdrop");
        const cancelBtn = document.getElementById("cmp-modal-cancel");
        const confirmBtn = document.getElementById("cmp-modal-confirm");
        const errorBox = document.getElementById("cmp-modal-error");
        const API_DELETE = "{% url 'comparison:api_delete' pk=cmp.pk %}";

        function openModal() {
            modal.classList.remove("hidden");
            errorBox.classList.add("hidden");
            confirmBtn.disabled = false;
            confirmBtn.textContent = "Delete";
        }
        function closeModal() {
            modal.classList.add("hidden");
        }

        if (delBtn) delBtn.addEventListener("click", openModal);
        if (cancelBtn) cancelBtn.addEventListener("click", closeModal);
        if (backdrop) backdrop.addEventListener("click", closeModal);
        document.addEventListener("keydown", (e) => {
            if (!modal.classList.contains("hidden") && e.key === "Escape") closeModal();
        });

        if (confirmBtn) {
            confirmBtn.addEventListener("click", async () => {
                confirmBtn.disabled = true;
                confirmBtn.textContent = "Deleting…";
                errorBox.classList.add("hidden");
                try {
                    const res = await fetch(API_DELETE, {
                        method: "POST",
                        headers: {
                            "X-Requested-With": "XMLHttpRequest",
                            "X-CSRFToken": getCSRF(),
                            "Accept": "application/json"
                        },
                        credentials: "same-origin"
                    });
                    const json = await res.json().catch(() => ({}));
                    if (!res.ok || json.ok === false) {
                        errorBox.textContent = json.error || `Failed to delete (status ${res.status}).`;
                        errorBox.classList.remove("hidden");
                        confirmBtn.disabled = false;
                        confirmBtn.textContent = "Delete";
                        return;
                    }
                    window.location.href = json.redirect || "{% url 'comparison:list_page' %}";
                } catch (e) {
                    errorBox.textContent = "Network error while deleting. Please try again.";
                    errorBox.classList.remove("hidden");
                    confirmBtn.disabled = false;
                    confirmBtn.textContent = "Delete";
                }
            });
        }
    })();
</script>
{% endblock content %}
