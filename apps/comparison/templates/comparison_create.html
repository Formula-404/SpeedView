{% extends "base.html" %}
{% load static %}

{% block meta %}
    <title>Create Comparison – SpeedView</title>
    <style>
        .input-field { transition: all .2s ease; }
        .input-field:focus { transform: translateY(-1px); }
        .card { border: 1px solid rgba(255,255,255,.1); background: rgba(255,255,255,.05); }
        .card:hover { border-color: rgba(239,68,68,.4); }
        .card.selected { border-color: rgba(239,68,68,.8) !important; box-shadow: 0 0 0 2px rgba(239,68,68,.2) inset; }
        .modal-backdrop { background: rgba(0,0,0,.6); }
    </style>
{% endblock meta %}

{% block content %}
<div class="px-12 py-12 mx-auto">
    <!-- Header -->
    <div class="mb-8">
        <div class="text-sm text-white/60 tracking-wide mb-3 space-x-2">
            <a class="hover:text-red-400" href="{% url 'main:show_main' %}">Home</a>
            <span>›</span>
            <a class="hover:text-red-400" href="{% url 'main:show_main' %}">Comparison</a>
            <span>›</span>
            <span class="text-white">Create</span>
        </div>
        <h1 class="text-4xl font-bold text-white" style="font-family: Alphacorsa, Inter, sans-serif;">Create Comparison</h1>
        <p class="text-white/60 mt-1">Choose a module, set a title, and select 2–4 items to compare.</p>
    </div>

    <!-- Title -->
    <div class="rounded-2xl bg-[#0D1117]/80 border border-white/10 p-6 mb-6">
        <h2 class="text-white text-lg font-semibold mb-3">Title <span class="text-red-400">*</span></h2>
        <input
            id="title"
            type="text"
            maxlength="100"
            placeholder="Enter comparison title..."
            class="input-field w-full px-4 py-2.5 rounded-lg bg-[#0D1117] border border-white/10 text-white placeholder-white/40 focus:outline-none focus:ring-2 focus:ring-red-500 focus:border-transparent"
        />
    </div>
    <div class="rounded-2xl bg-[#0D1117]/80 border border-white/10 p-6 mb-6">
        <h2 class="text-white text-lg font-semibold mb-3">Visibility</h2>
        <label class="inline-flex items-center gap-2 text-white/80">
            <input id="is-public" type="checkbox" class="h-4 w-4 accent-red-600">
            <span>Make this comparison public</span>
        </label>
    </div>


    <!-- Module -->
    <div class="rounded-2xl bg-[#0D1117]/80 border border-white/10 p-6 mb-6">
        <h2 class="text-white text-lg font-semibold mb-3">Module</h2>
        <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
            <button data-module="team" class="module-btn px-4 py-3 rounded-lg border border-white/10 bg-white/5 text-white hover:border-red-500/40">Team</button>
            <button data-module="car" class="module-btn px-4 py-3 rounded-lg border border-white/10 bg-white/5 text-white/60 hover:text-white">Car</button>
            <button data-module="driver" class="module-btn px-4 py-3 rounded-lg border border-white/10 bg-white/5 text-white/60 hover:text-white">Driver</button>
            <button data-module="circuit" class="module-btn px-4 py-3 rounded-lg border border-white/10 bg-white/5 text-white/60 hover:text-white">Circuit</button>
        </div>
    </div>

    <!-- Picker -->
    <div class="rounded-2xl bg-[#0D1117]/80 border border-white/10 p-6">
        <div class="flex items-center justify-between mb-4">
            <h2 id="picker-title" class="text-white text-lg font-semibold">Select Teams</h2>
            <div class="text-sm text-white/60">Pick 2–4</div>
        </div>
        <div class="flex items-center gap-3 mb-4">
            <input id="search" type="text" placeholder="Search…" class="input-field w-72 px-4 py-2.5 rounded-lg bg-[#0D1117] border border-white/10 text-white placeholder-white/40 focus:outline-none focus:ring-2 focus:ring-red-500 focus:border-transparent">
            <div id="count" class="text-white/60 text-sm">0 selected</div>
        </div>
        <div id="list" class="grid gap-3 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4"></div>
        <template id="opt-tpl">
            <button type="button" class="card flex items-center gap-3 rounded-xl p-3 text-left">
                <img class="h-8 w-8 rounded bg-white/5 object-contain" />
                <div class="min-w-0">
                    <div class="text-white font-medium truncate"></div>
                    <div class="text-xs text-white/60 truncate"></div>
                </div>
            </button>
        </template>
        <div class="flex justify-end gap-3 mt-6">
            <a href="{% url 'comparison:list_page' %}" class="px-6 py-2.5 rounded-lg bg-white/5 border border-white/10 text-white/80 hover:text-white">Cancel</a>
            <button id="create-btn" class="px-6 py-2.5 rounded-lg bg-red-600 text-white font-semibold hover:bg-red-700">Create</button>
        </div>
    </div>
</div>

<!-- Popup -->
<div id="popup" class="fixed inset-0 z-50 hidden">
    <div class="modal-backdrop absolute inset-0"></div>
    <div class="absolute inset-0 flex items-center justify-center px-4">
        <div class="w-full max-w-sm rounded-2xl bg-[#0B0F14] border border-white/10 shadow-xl p-5">
            <h3 id="popup-title" class="text-red-400 text-lg font-semibold mb-2">Invalid Selection</h3>
            <div id="popup-msg" class="text-white/80 text-sm mb-4">Please pick 2–4 items.</div>
            <div class="flex justify-end">
                <button id="popup-close" class="px-4 py-2 rounded-lg bg-red-600 text-white font-semibold hover:bg-red-700">Close</button>
            </div>
        </div>
    </div>
</div>

<script>
    /* helpers */
    function showPopup(message, title = "Invalid Selection") {
        const modal = document.getElementById("popup");
        document.getElementById("popup-title").textContent = title;
        document.getElementById("popup-msg").textContent = message;
        modal.classList.remove("hidden");
    }
    document.getElementById("popup-close").addEventListener("click", () => {
        document.getElementById("popup").classList.add("hidden");
    });

    function getCSRF() {
        const name = "csrftoken=";
        return document.cookie.split(";").map(s => s.trim()).find(s => s.startsWith(name))?.slice(name.length) || "";
    }

    async function postJSON(url, body) {
        const res = await fetch(url, {
            method: "POST",
            credentials: "same-origin",
            headers: {
                "Content-Type": "application/json",
                "Accept": "application/json",
                "X-Requested-With": "XMLHttpRequest",
                "X-CSRFToken": getCSRF(),
            },
            body: JSON.stringify(body),
        });
        const ct = res.headers.get("content-type") || "";
        if (!ct.startsWith("application/json")) {
            const hint = res.redirected ? "You may need to log in." : "Server returned HTML.";
            throw new Error(`${hint} (${res.status}).`);
        }
        const json = await res.json();
        if (!res.ok || json.ok === false) {
            throw new Error(json.error || `Request failed (${res.status}).`);
        }
        return json;
    }

    (function() {
        /* state */
        let moduleSel = "team";
        let options = [];
        let filtered = [];
        let selected = new Set();

        /* nodes */
        const list = document.getElementById("list");
        const tpl = document.getElementById("opt-tpl");
        const search = document.getElementById("search");
        const count = document.getElementById("count");
        const createBtn = document.getElementById("create-btn");
        const pickerTitle = document.getElementById("picker-title");

        /* module */
        document.querySelectorAll(".module-btn").forEach(btn => {
            btn.addEventListener("click", () => {
                moduleSel = btn.dataset.module;
                document.querySelectorAll(".module-btn").forEach(b => b.classList.remove("border-red-500","text-white"));
                btn.classList.add("border-red-500","text-white");
                pickerTitle.textContent = (
                    moduleSel === "team" ? "Select Teams" :
                    moduleSel === "car" ? "Select Cars" :
                    moduleSel === "driver" ? "Select Drivers" :
                    "Select Circuits"
                );
                selected.clear();
                updateCount();
                loadOptions();
            });
        });

        /* options loader */
        async function loadOptions() {
            let url = "";
            if (moduleSel === "team") url = "{% url 'team:api_list' %}";
            if (moduleSel === "driver") url = "{% url 'driver:api_list' %}";
            if (moduleSel === "circuit") url = "{% url 'circuit:api_list' %}";
            if (moduleSel === "car") url = "{% url 'car:show_json' %}";

            list.innerHTML = "";
            options = [];
            filtered = [];
            try {
                const res = await fetch(url);
                const json = await res.json();
                if (!res.ok || json.ok === false) throw new Error("Failed");

                if (moduleSel === "team") {
                    options = (json.data || []).map(t => ({
                        id: t.team_name,
                        name: t.team_name,
                        sub: t.short_code || "",
                        logo: t.team_logo_url || "https://www.edigitalagency.com.au/wp-content/uploads/F1-logo-png-medium-size.png"
                    }));
                } else if (moduleSel === "driver") {
                    options = (json.data || []).map(d => ({
                        id: d.driver_number,
                        name: d.full_name || d.broadcast_name || `#${d.driver_number}`,
                        sub: d.country_code || "",
                        logo: d.headshot_url || "https://static-00.iconduck.com/assets.00/user-avatar-icon-512x512-w56v6b1r.png"
                    }));
                } else if (moduleSel === "circuit") {
                    options = (json.data || []).map(c => ({
                        id: String(c.id),
                        name: c.name,
                        sub: [c.location, c.country].filter(Boolean).join(" • "),
                        logo: c.map_image_url || "https://via.placeholder.com/64x64.png?text=Track"
                    }));
                } else {
                    options = (json || []).map(c => ({
                        id: c.id,
                        name: `${c.driver_number} – ${c.session_name || "Session"}`,
                        sub: `Speed ${c.speed ?? 0}`,
                        logo: "https://static.thenounproject.com/png/3790881-200.png"
                    }));
                }

                filtered = options.slice();
                render();
            } catch (_) {
                list.innerHTML = `<div class="text-red-400">Failed to load items.</div>`;
            }
        }

        /* render */
        function render() {
            list.innerHTML = "";
            for (const opt of filtered) {
                const n = tpl.content.firstElementChild.cloneNode(true);
                n.dataset.id = String(opt.id);
                n.querySelector("img").src = opt.logo;
                n.querySelector(".text-white").textContent = opt.name;
                n.querySelector(".text-xs").textContent = opt.sub;
                if (selected.has(String(opt.id))) n.classList.add("selected");
                n.addEventListener("click", () => toggleSelect(String(opt.id), n));
                list.appendChild(n);
            }
            updateCount();
        }

        /* search */
        search.addEventListener("input", () => {
            const q = search.value.trim().toLowerCase();
            filtered = options.filter(o =>
                o.name.toLowerCase().includes(q) ||
                o.sub.toLowerCase().includes(q)
            );
            render();
        });

        /* selection */
        function toggleSelect(id, node) {
            if (selected.has(id)) {
                selected.delete(id);
                node.classList.remove("selected");
            } else {
                if (selected.size >= 4) return;
                selected.add(id);
                node.classList.add("selected");
            }
            updateCount();
        }

        function updateCount() {
            count.textContent = `${selected.size} selected`;
            Array.from(list.children).forEach(node => {
                const id = node.dataset.id;
                if (!selected.has(id) && selected.size >= 4) {
                    node.classList.add("pointer-events-none", "opacity-60");
                } else {
                    node.classList.remove("pointer-events-none", "opacity-60");
                }
            });
        }

        /* create */
        const createURL = "{% url 'comparison:api_create' %}";
        document.getElementById("create-btn").addEventListener("click", async () => {
            const items = Array.from(selected);
            const title = document.getElementById("title").value.trim();

            if (items.length < 2 || items.length > 4) {
                showPopup("You must pick between 2 and 4 items to create a comparison.");
                return;
            }
            if (!title) {
                showPopup("Please enter a title for your comparison.", "Missing Title");
                return;
            }

            try {
                const isPublic = document.getElementById("is-public").checked;
                const json = await postJSON(createURL, { title, module: moduleSel, items, is_public: isPublic });

                const redirect = json.redirect || json.data?.detail_url || "";
                if (redirect) {
                    window.location.href = redirect;
                } else {
                    showPopup("Created, but missing redirect URL.");
                }
            } catch (e) {
                showPopup(e.message || "Failed to create comparison.", "Create Failed");
            }
        });

        loadOptions();
    })();
</script>
{% endblock content %}
