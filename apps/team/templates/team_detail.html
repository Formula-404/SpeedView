{% extends "base.html" %}
{% load static user_extras %}

{% block meta %}
    <title>Team – SpeedView</title>
    <style>
        .skeleton { position: relative; overflow: hidden; background: rgba(255,255,255,0.08); }
        .skeleton::after { content: ""; position: absolute; inset: 0; transform: translateX(-100%); background: linear-gradient(90deg, transparent, rgba(255,255,255,.08), transparent); animation: shimmer 1.2s infinite; }
        @keyframes shimmer { 100% { transform: translateX(100%); } }
        .icon-btn { display: inline-flex; align-items: center; justify-content: center; padding: 6px; border-radius: 10px; background: rgba(255,255,255,0.06); border: 1px solid rgba(255,255,255,0.12); transition: transform .15s ease, background .15s ease, border-color .15s ease; }
        .icon-btn:hover { transform: translateY(-1px); background: rgba(255,255,255,0.1); border-color: rgba(255,255,255,0.2); }
        .icon-btn img { width: 18px; height: 18px; display: block; }
        .gap-x-1_5 { column-gap: 0.375rem; }
    </style>
{% endblock meta %}

{% block content %}
    <!-- Breadcrumb -->
    <div class="px-12 py-12 mx-auto">
        <div class="text-sm text-white/60 tracking-wide mb-3 space-x-2">
            <a class="hover:text-red-400" href="{% url 'main:show_main' %}">Home</a>
            <span>›</span>
            <a class="hover:text-red-400" href="{% url 'team:list_page' %}">Team</a>
            <span>›</span>
            <span id="bc-team" class="text-white">Loading…</span>
        </div>

        <!-- Hero -->
        <div id="hero" class="rounded-2xl border border-white/10 overflow-hidden">
            <div id="hero-top" class="p-6 md:p-8 bg-[--team-hero-bg]">
                <div class="flex items-start gap-5">
                    <img id="team-logo" alt="Team logo" class="h-16 w-16 md:h-20 md:w-20 rounded-lg object-contain bg-white/10 skeleton" />
                    <div class="min-w-0 flex-1">
                        <div class="flex items-center gap-3">
                            <h1 id="team-title" class="text-3xl md:text-4xl font-bold text-white" style="font-family: Alphacorsa, Inter, sans-serif;">Loading…</h1>
                            <span id="code-badge" class="px-2 py-0.5 text-[11px] font-bold rounded bg-white/10 border border-white/15 text-white/80 skeleton">—</span>
                            <span id="active-badge" class="px-2.5 py-1 text-[10px] rounded-full border text-white/80">—</span>
                            <div class="ml-auto flex items-center gap-x-1_5">
                                {% if request.user.is_authenticated and request.user|is_admin_user %}
                                    <a id="edit-link" href="#" class="icon-btn" title="Edit">
                                        <img alt="Edit" src="https://img.icons8.com/?size=100&id=kCViyr9hZtLX&format=png&color=FFFFFF" />
                                    </a>
                                    <button id="delete-btn" type="button" class="icon-btn" title="Delete">
                                        <img alt="Delete" src="https://img.icons8.com/?size=100&id=85194&format=png&color=FFFFFF" />
                                    </button>
                                {% endif %}
                            </div>
                        </div>
                        <p id="country-base" class="text-white/70 mt-1"></p>
                        <div class="mt-3 flex flex-wrap items-center gap-2">
                            <a id="site-link" href="#" target="_blank" rel="noopener" class="hidden inline-flex items-center gap-1 text-sm px-2.5 py-1 rounded bg-white/5 border border-white/10 text-white/80 hover:text-white hover:bg-white/10 transition">Website</a>
                            <a id="wiki-link" href="#" target="_blank" rel="noopener" class="hidden inline-flex items-center gap-1 text-sm px-2.5 py-1 rounded bg-white/5 border border-white/10 text-white/80 hover:text-white hover:bg-white/10 transition">Wikipedia</a>
                        </div>
                    </div>
                </div>
            </div>
            <div class="px-6 md:px-8 py-5 bg-[#0D1117]/80 border-t border-white/10">
                <div class="grid sm:grid-cols-2 lg:grid-cols-3 gap-4">
                    <div class="flex items-center gap-3">
                        <span class="inline-block h-6 w-6 rounded border border-white/10" id="color-prim"></span>
                        <div>
                            <div class="text-xs text-white/60">Primary color</div>
                            <div id="hex-prim" class="text-white/90 font-medium">—</div>
                        </div>
                    </div>
                    <div class="flex items-center gap-3">
                        <span class="inline-block h-6 w-6 rounded border border-white/10" id="color-sec"></span>
                        <div>
                            <div class="text-xs text-white/60">Secondary color</div>
                            <div id="hex-sec" class="text-white/90 font-medium">—</div>
                        </div>
                    </div>
                    <div class="flex items-center gap-3">
                        <div>
                            <div class="text-xs text-white/60">Founded</div>
                            <div id="founded" class="text-white/90 font-medium">—</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- About & Engines -->
        <div class="mt-6 grid lg:grid-cols-3 gap-6">
            <div class="lg:col-span-2 rounded-2xl bg-[#0D1117]/80 border border-white/10 p-6">
                <h2 class="text-white text-lg font-semibold mb-3">About</h2>
                <p id="desc" class="text-white/80 leading-relaxed"><span class="skeleton inline-block w-1/2 h-4 rounded"></span></p>
            </div>
            <div class="rounded-2xl bg-[#0D1117]/80 border border-white/10 p-6">
                <h2 class="text-white text-lg font-semibold mb-3">Engines</h2>
                <div id="engines" class="flex flex-wrap gap-2">
                    <span class="skeleton inline-block h-6 w-16 rounded"></span>
                    <span class="skeleton inline-block h-6 w-12 rounded"></span>
                </div>
            </div>
        </div>

        <!-- Career Stats -->
        <div class="mt-6 rounded-2xl bg-[#0D1117]/80 border border-white/10 p-6">
            <h2 class="text-white text-lg font-semibold mb-4">Career Stats</h2>
            <div class="grid sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-6 gap-4">
                <div class="rounded-xl bg-white/5 border border-white/10 p-4">
                    <div class="text-xs text-white/60">Races entered</div>
                    <div id="s-races" class="text-xl font-semibold text-white">0</div>
                </div>
                <div class="rounded-xl bg-white/5 border border-white/10 p-4">
                    <div class="text-xs text-white/60">Wins</div>
                    <div id="s-wins" class="text-xl font-semibold text-white">0</div>
                </div>
                <div class="rounded-xl bg-white/5 border border-white/10 p-4">
                    <div class="text-xs text-white/60">Podiums</div>
                    <div id="s-podiums" class="text-xl font-semibold text-white">0</div>
                </div>
                <div class="rounded-xl bg-white/5 border border-white/10 p-4">
                    <div class="text-xs text-white/60">Points</div>
                    <div id="s-points" class="text-xl font-semibold text-white">0</div>
                </div>
                <div class="rounded-xl bg-white/5 border border-white/10 p-4">
                    <div class="text-xs text-white/60">Constructors’ titles</div>
                    <div id="s-cc" class="text-xl font-semibold text-white">0</div>
                </div>
                <div class="rounded-xl bg-white/5 border border-white/10 p-4">
                    <div class="text-xs text-white/60">Drivers’ titles</div>
                    <div id="s-dc" class="text-xl font-semibold text-white">0</div>
                </div>
            </div>
        </div>

        <!-- Performance -->
        <div class="mt-6 rounded-2xl bg-[#0D1117]/80 border border-white/10 p-6">
            <h2 class="text-white text-lg font-semibold mb-4">Performance</h2>
            <div class="grid sm:grid-cols-2 lg:grid-cols-4 gap-4">
                <div class="rounded-xl bg-white/5 border border-white/10 p-4">
                    <div class="text-xs text-white/60">Average lap</div>
                    <div id="p-avg-lap" class="text-xl font-semibold text-white">—</div>
                </div>
                <div class="rounded-xl bg-white/5 border border-white/10 p-4">
                    <div class="text-xs text-white/60">Best lap</div>
                    <div id="p-best-lap" class="text-xl font-semibold text-white">—</div>
                </div>
                <div class="rounded-xl bg-white/5 border border-white/10 p-4">
                    <div class="text-xs text-white/60">Avg. pit stop</div>
                    <div id="p-avg-pit" class="text-xl font-semibold text-white">—</div>
                </div>
                <div class="rounded-xl bg-white/5 border border-white/10 p-4">
                    <div class="text-xs text-white/60">Top speed</div>
                    <div id="p-top-speed" class="text-xl font-semibold text-white">—</div>
                </div>
            </div>
            <div class="mt-3 text-xs text-white/50">* Lap & pit times formatted as m:ss.mmm</div>
        </div>

        <!-- Meta -->
        <div class="mt-6 text-xs text-white/40">
            <span>Created: <span id="meta-created">—</span></span>
            <span class="mx-2">•</span>
            <span>Updated: <span id="meta-updated">—</span></span>
        </div>
    </div>

    <!-- Delete Modal -->
    <div id="delete-modal" class="fixed inset-0 z-50 hidden">
        <div id="modal-backdrop" class="absolute inset-0 bg-black/60"></div>
        <div class="absolute inset-0 flex items-center justify-center px-4">
            <div class="w-full max-w-md rounded-2xl bg-[#0B0F14] border border-white/10 shadow-xl">
                <div class="p-5 border-b border-white/10">
                    <h3 class="text-white text-lg font-semibold">Delete Team</h3>
                </div>
                <div class="p-5 space-y-3">
                    <p class="text-white/80">Are you sure you want to delete <span id="modal-team-name" class="font-semibold text-white"></span>?</p>
                    <p class="text-white/60 text-sm">This action cannot be undone.</p>
                    <div id="modal-error" class="hidden text-red-400 text-sm"></div>
                </div>
                <div class="px-5 pb-5 pt-2 flex items-center justify-end gap-2">
                    <button id="modal-cancel" type="button" class="px-3 py-2 rounded-lg bg-white/10 border border-white/15 text-white/90 hover:bg-white/15 transition">Cancel</button>
                    <button id="modal-confirm" type="button" class="px-3 py-2 rounded-lg bg-red-600 text-white font-semibold hover:bg-red-700 transition">Delete</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        (function() {
            /* helpers */
            const byId = (id) => document.getElementById(id);

            function msToClock(ms) {
                if (ms === null || ms === undefined || isNaN(ms)) return "—";
                const totalMs = Math.round(ms);
                const minutes = Math.floor(totalMs / 60000);
                const seconds = Math.floor((totalMs % 60000) / 1000);
                const millis = totalMs % 1000;
                return `${minutes}:${String(seconds).padStart(2, "0")}.${String(millis).padStart(3, "0")}`;
            }

            function fmtInt(v) {
                if (v === null || v === undefined) return "0";
                return Number(v).toLocaleString();
            }

            function fmtDate(iso) {
                if (!iso) return "—";
                const d = new Date(iso);
                if (isNaN(d.getTime())) return "—";
                return d.toLocaleString();
            }

            function chipsFromCSV(csv) {
                return (csv || "").split(",").map(s => s.trim()).filter(Boolean);
            }

            function getTeamNameFromPath() {
                const parts = window.location.pathname.split("/").filter(Boolean);
                return decodeURIComponent(parts[parts.length - 1] || "");
            }

            function getCSRF() {
                const name = "csrftoken=";
                const c = document.cookie.split(";").map(s => s.trim());
                for (const kv of c) if (kv.startsWith(name)) return decodeURIComponent(kv.slice(name.length));
                return "";
            }

            /* urls */
            const teamName = getTeamNameFromPath();
            const API_DETAIL = `{% url 'team:api_detail' team_name='__TEAM__' %}`.replace('__TEAM__', encodeURIComponent(teamName));
            const API_DELETE = `{% url 'team:api_delete' team_name='__TEAM__' %}`.replace('__TEAM__', encodeURIComponent(teamName));
            const EDIT_PAGE = `{% url 'team:edit_page' team_name='__TEAM__' %}`.replace('__TEAM__', encodeURIComponent(teamName));
            const LIST_PAGE = `{% url 'team:list_page' %}`;

            /* nodes */
            const bcTeam = byId("bc-team");
            const logo = byId("team-logo");
            const title = byId("team-title");
            const code = byId("code-badge");
            const active = byId("active-badge");
            const heroTop = byId("hero-top");
            const site = byId("site-link");
            const wiki = byId("wiki-link");
            const edit = byId("edit-link");
            const del = byId("delete-btn");

            const countryBase = byId("country-base");
            const colorPrim = byId("color-prim");
            const colorSec = byId("color-sec");
            const hexPrim = byId("hex-prim");
            const hexSec = byId("hex-sec");
            const founded = byId("founded");
            const desc = byId("desc");
            const enginesBox = byId("engines");

            const sRaces = byId("s-races");
            const sWins = byId("s-wins");
            const sPod = byId("s-podiums");
            const sPts = byId("s-points");
            const sCC = byId("s-cc");
            const sDC = byId("s-dc");

            const pAvgLap = byId("p-avg-lap");
            const pBest = byId("p-best-lap");
            const pAvgPit = byId("p-avg-pit");
            const pTop = byId("p-top-speed");

            const metaCreated = byId("meta-created");
            const metaUpdated = byId("meta-updated");

            const modal = byId("delete-modal");
            const modalBackdrop = byId("modal-backdrop");
            const modalCancel = byId("modal-cancel");
            const modalConfirm = byId("modal-confirm");
            const modalTeamName = byId("modal-team-name");
            const modalError = byId("modal-error");

            /* edit link */
            if (edit) edit.href = EDIT_PAGE;

            /* delete modal */
            function openModal() {
                modalTeamName.textContent = bcTeam.textContent || teamName;
                modal.classList.remove("hidden");
                modalError.classList.add("hidden");
                modalConfirm.disabled = false;
                modalConfirm.textContent = "Delete";
                setTimeout(() => modalConfirm.focus(), 0);
            }
            function closeModal() {
                modal.classList.add("hidden");
            }
            if (del) del.addEventListener("click", openModal);
            if (modalCancel) modalCancel.addEventListener("click", closeModal);
            if (modalBackdrop) modalBackdrop.addEventListener("click", closeModal);
            document.addEventListener("keydown", (e) => { if (!modal.classList.contains("hidden") && e.key === "Escape") closeModal(); });

            if (modalConfirm) {
                modalConfirm.addEventListener("click", async () => {
                    modalConfirm.disabled = true;
                    modalConfirm.textContent = "Deleting…";
                    modalError.classList.add("hidden");
                    try {
                        const res = await fetch(API_DELETE, {
                            method: "POST",
                            headers: {
                                "X-CSRFToken": getCSRF(),
                                "X-Requested-With": "XMLHttpRequest",
                                "Accept": "application/json"
                            }
                        });
                        const json = await res.json().catch(() => ({}));
                        if (!res.ok || json.ok === false) {
                            modalError.textContent = json.error || `Failed to delete (status ${res.status}).`;
                            modalError.classList.remove("hidden");
                            modalConfirm.disabled = false;
                            modalConfirm.textContent = "Delete";
                            return;
                        }
                        window.location.href = LIST_PAGE;
                    } catch (_) {
                        modalError.textContent = "Network error while deleting. Please try again.";
                        modalError.classList.remove("hidden");
                        modalConfirm.disabled = false;
                        modalConfirm.textContent = "Delete";
                    }
                });
            }

            /* boot */
            async function boot() {
                try {
                    const res = await fetch(API_DETAIL);
                    if (!res.ok) throw new Error(`Status ${res.status}`);
                    const json = await res.json();
                    if (!json.ok) throw new Error(json.error || "Failed");

                    const t = json.data || {};

                    bcTeam.textContent = t.team_name || teamName || "Unknown Team";
                    title.textContent = t.team_name || "Unknown Team";

                    const fallback = "https://www.edigitalagency.com.au/wp-content/uploads/F1-logo-png-medium-size.png";
                    logo.src = t.team_logo_url || fallback;
                    logo.onload = () => logo.classList.remove("skeleton");
                    logo.onerror = () => { logo.src = fallback; logo.classList.remove("skeleton"); };

                    code.textContent = t.short_code || "—";
                    code.classList.remove("skeleton");

                    if (t.is_active) {
                        active.textContent = "ACTIVE";
                        active.className = "px-2.5 py-1 text-[10px] rounded-full border border-green-500/40 text-green-400 bg-green-500/10";
                    } else {
                        active.textContent = "INACTIVE";
                        active.className = "px-2.5 py-1 text-[10px] rounded-full border border-white/20 text-white/70 bg-white/5";
                    }

                    const primHex = (t.team_colour_hex || "").trim() || "#e11d48";
                    heroTop.style.setProperty("--team-hero-bg", `linear-gradient(135deg, ${primHex}1a 0%, transparent 60%)`);

                    const parts = [];
                    if (t.country) parts.push(t.country);
                    if (t.base) parts.push(t.base);
                    countryBase.textContent = parts.join(" • ") || "—";

                    if (t.website) { site.href = t.website; site.classList.remove("hidden"); }
                    if (t.wiki_url) { wiki.href = t.wiki_url; wiki.classList.remove("hidden"); }

                    colorPrim.style.background = primHex;
                    hexPrim.textContent = primHex;
                    if (t.team_colour_secondary) {
                        const sec = `#${t.team_colour_secondary}`;
                        colorSec.style.background = sec;
                        hexSec.textContent = sec;
                    } else {
                        colorSec.style.background = "transparent";
                        hexSec.textContent = "—";
                    }

                    founded.textContent = t.founded_year || "—";
                    desc.textContent = t.team_description || "No description provided.";

                    enginesBox.innerHTML = "";
                    const engs = chipsFromCSV(t.engines);
                    if (!engs.length) {
                        enginesBox.innerHTML = `<span class="text-white/60 text-sm">No engine data.</span>`;
                    } else {
                        for (const e of engs) {
                            const span = document.createElement("span");
                            span.className = "text-xs px-2.5 py-1 rounded-full bg-white/5 border border-white/10 text-white/80";
                            span.textContent = e;
                            enginesBox.appendChild(span);
                        }
                    }

                    sRaces.textContent = fmtInt(t.races_entered);
                    sWins.textContent = fmtInt(t.race_victories);
                    sPod.textContent = fmtInt(t.podiums);
                    sPts.textContent = fmtInt(t.points);
                    sCC.textContent = fmtInt(t.constructors_championships);
                    sDC.textContent = fmtInt(t.drivers_championships);

                    pAvgLap.textContent = msToClock(t.avg_lap_time_ms);
                    pBest.textContent = msToClock(t.best_lap_time_ms);
                    pAvgPit.textContent = msToClock(t.avg_pit_duration_ms);
                    pTop.textContent = (t.top_speed_kph ? `${t.top_speed_kph} kph` : "—");

                    metaCreated.textContent = fmtDate(t.created_at);
                    metaUpdated.textContent = fmtDate(t.updated_at);
                } catch (_) {
                    const container = document.createElement("div");
                    container.className = "mt-6 rounded-2xl bg-white/5 border border-white/10 p-8 text-center text-red-400";
                    container.textContent = "Failed to load team data. Please return to the Teams page.";
                    document.currentScript.parentElement.appendChild(container);
                }
            }

            boot();
        })();
    </script>
{% endblock content %}
